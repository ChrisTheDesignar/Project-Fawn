---
import { TOPICS, toSlug } from "@/lib/topics";

const params = new URLSearchParams(Astro.url.search);
const active = (params.get("topic") || "").toLowerCase();
---

<nav class="topic-filter">
  <ul class="flex flex-wrap gap-2">
    <li class={active ? "" : "active"}>
      <a class="pill" data-topic href={Astro.url.pathname}>All</a>
    </li>
    {TOPICS.map(t => {
      const slug = toSlug(t);
      return (
        <li class={active === slug ? "active" : ""}>
          <a class="pill" data-topic href={`?topic=${slug}`}>{t}</a>
        </li>
      );
    })}
  </ul>
</nav>

<style>
/* Use your existing green pill styling: */
.pill { display:inline-block; padding:.25rem .6rem; border:1px solid var(--border,#cbd5e1); border-radius:999px; font-size:.85rem; }
.topic-filter li.active .pill { background:#10b981; border-color:#10b981; color:#fff; } /* green */
</style>

<script is:client>
(() => {
  if (window.__researchFilterInit__) return;
  window.__researchFilterInit__ = true;

  const slug = s => (s||'').toLowerCase().replace(/\s+/g,'-');
  const getCards = () => Array.from(document.querySelectorAll('[data-topics]'));

  function apply() {
    const url = new URL(location.href);
    const q = (url.searchParams.get('topic') || '').toLowerCase();
    getCards().forEach(el => {
      const topics = (el.getAttribute('data-topics') || '').split(',');
      el.hidden = !!q && !topics.includes(q);
    });
    document.querySelectorAll('.topic-filter li').forEach(li => li.classList.remove('active'));
    const sel = q ? `.topic-filter a[href="?topic=${q}"]` : `.topic-filter a[href="${location.pathname}"]`;
    document.querySelector(sel)?.parentElement?.classList.add('active');
  }

  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[data-topic], .topic-filter a');
    if (!a) return;
    const href = a.getAttribute('href') || '';
    if (href.startsWith('?topic=') || href === location.pathname) {
      e.preventDefault();
      const url = new URL(location.href);
      if (href === location.pathname) url.searchParams.delete('topic');
      else url.searchParams.set('topic', href.split('=')[1]);
      history.pushState({}, '', url);
      apply();
    }
  });

  window.addEventListener('popstate', apply);
  apply();
})();
</script>

