---
import { normalizeTopics, toSlug } from "@/lib/topics";

type Link = { href: string; label: string };
interface Props {
  title: string;
  topic: string | string[];
  date: string;             // YYYY-MM-DD
  summary: string;
  links?: Link[];
}

const p = Astro.props as Props;
const topics = normalizeTopics(p.topic);
const topicSlugs = topics.map(toSlug);

// “term” used by giscus + fallback link
const term = `${p.date}::${p.title}`;
const ghDiscuss =
  `https://github.com/ChrisTheDesignar/Project-Fawn/discussions/new` +
  `?category=${encodeURIComponent('Research Card Comments')}` +
  `&title=${encodeURIComponent(term)}`;
---

<article class="rcard" data-topics={topicSlugs.join(',')}>
  <div class="rcard-grid">
    <!-- MEDIA -->
    <div class="media">
      <slot name="media" />
    </div>

    <!-- TEXT -->
    <div class="meta">
      <header class="head">
        <h3 class="title">{p.title}</h3>
        <time datetime={p.date} class="date">{p.date}</time>
      </header>

      <p class="summary">{p.summary}</p>

      {p.links?.length ? (
        <ul class="links">
          {p.links.map((l) => (
            <li><a href={l.href} target="_blank" rel="noopener">{l.label}</a></li>
          ))}
        </ul>
      ) : null}

      <!-- Topic pills -->
      <ul class="pills">
        {topics.map((t) => (
          <li><a class="pill" data-topic href={`?topic=${toSlug(t)}`}>{t}</a></li>
        ))}
      </ul>

      <!-- COMMENTS -->
      <details class="comments" data-term={term}>
        <summary>Comments</summary>

        <div class="comment-actions">
          <a class="gh-discuss" href={ghDiscuss} target="_blank" rel="noopener">Open on GitHub</a>
        </div>

        <!-- giscus mounts here when opened -->
        <div class="cwrap"></div>
      </details>
    </div>
  </div>
</article>

<style>
/* CARD */
.rcard{border:1px solid #2a2f3a;border-radius:14px;background:#0b0f14;padding:14px}
.rcard-grid{display:grid;gap:14px}
@media (min-width: 900px){ .rcard-grid{grid-template-columns: 360px 1fr; align-items:start} }

/* MEDIA */
.media{border-radius:10px;overflow:hidden;background:#00000025;min-height:220px}
@media (min-width: 900px){ .media{min-height:260px} }
.media :global(img), .media :global(video), .media :global(iframe){ width:100%; height:100%; display:block; }
.media :global(iframe){ border:0 }

/* TEXT */
.head{display:flex; align-items:baseline; justify-content:space-between; gap:.5rem; margin-bottom:.25rem}
.title{font-weight:700; text-transform:uppercase; letter-spacing:.04em}
.date{opacity:.75; font-size:.9rem}
.summary{margin:.25rem 0 .6rem}
.links,.pills{display:flex; flex-wrap:wrap; gap:.45rem; list-style:none; padding:0; margin:0 0 .5rem}
.pill{display:inline-block; padding:.22rem .58rem; border:1px solid #0ea66b; border-radius:999px; font-size:.8rem; color:#0ea66b; background:#0ea66b22}
.pill:hover{background:#0ea66b33}

/* COMMENTS */
.comments > summary{cursor:pointer; font-size:.82rem; opacity:.9}
.comment-actions{margin-top:.35rem}
.gh-discuss{font-size:.78rem; opacity:.8; text-decoration:underline}
.cwrap{margin-top:.45rem}

/* Ensure the giscus iframe is visible and sized */
.rcard .cwrap .giscus,
.rcard .cwrap .giscus-frame{
  display:block;
  width:100%;
  min-height:340px;
  border:0;
}
.rcard details.comments[open] .cwrap{ padding-top:.5rem; }
</style>

<script is:client>
  // Mount one giscus instance per card when its comments panel first opens
  const root = document.currentScript.closest('.rcard');
  const details = root?.querySelector('details.comments');
  const wrap = root?.querySelector('.cwrap');
  const term = details?.getAttribute('data-term') || 'ResearchCard';

  let mounted = false;
  function mountGiscus() {
    if (!wrap || mounted) return;
    if (wrap.querySelector('.giscus-frame')) { mounted = true; return; }

    const s = document.createElement('script');
    s.src = 'https://giscus.app/client.js';
    s.async = true;

    s.setAttribute('data-repo', 'ChrisTheDesignar/Project-Fawn');
    s.setAttribute('data-repo-id', 'R_kgDOPFJPMg');
    s.setAttribute('data-category', 'Research Card Comments');
    s.setAttribute('data-category-id', 'DIC_kwDOPFJPMs4Cv22B');
    s.setAttribute('data-mapping', 'specific');
    s.setAttribute('data-term', term);
    s.setAttribute('data-reactions-enabled', '1');
    s.setAttribute('data-emit-metadata', '0');
    s.setAttribute('data-input-position', 'bottom');
    s.setAttribute('data-theme', 'preferred_color_scheme');
    s.setAttribute('crossorigin', 'anonymous');

    wrap.appendChild(s);
    mounted = true;
  }

  // Mount on first open; also mount immediately if already open on load
  details?.addEventListener('toggle', () => { if (details.open) mountGiscus(); }, { once: true });
  if (details?.open) mountGiscus();
</script>
