---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, getEntryBySlug } from 'astro:content';

export async function getStaticPaths() {
  const all = await getCollection('posts');
  return all.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = await getEntryBySlug('posts', slug);
if (!post) throw new Error(`Post not found: ${slug}`);

const { Content } = await post.render();

const formatDate = (d: Date) =>
  d.toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    timeZone: 'UTC',
  });
---

<BaseLayout title={post.data.title}>
  {post.data.cover && (
    <img
      src={post.data.cover.src}
      alt={post.data.coverAlt ?? post.data.title}
      style="display:block; width:100%; margin: 0 auto 1rem; aspect-ratio: 16/9; object-fit: cover; border:1px solid var(--border);"
      loading="eager"
    />
  )}

  <h1 style="margin:0 0 .25rem 0;">{post.data.title}</h1>
  <time datetime={post.data.pubDate.toISOString()} class="post-date">
    {formatDate(post.data.pubDate)}
  </time>

  <!-- Post content -->
  <div style="margin-top:1rem; line-height:1.6;">
    <Content />
  </div>

  <!-- Divider -->
  <hr class="rule" />

  <!-- Comments -->
  <section id="comments" class="comments" style="max-width:980px;margin:24px auto 0;">
    <h2 style="margin:0 0 .5rem 0;">Comments</h2>
    <div class="giscus" style="width:100%;">
      <script
        src="https://giscus.app/client.js"
        data-repo="ChrisTheDesignar/Project-Fawn"
        data-repo-id="R_kgDOPFJPMg"
        data-category="Blog Post Comments"
        data-category-id="DIC_kwDOPFJPMs4Cv23q"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
      </script>
      <noscript>
        Please enable JavaScript to view the comments powered by Giscus.
      </noscript>
    </div>
  </section>
</BaseLayout>
